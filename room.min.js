Peer.Room=Object.assign(function(a,b){var c=Peer.Room;c.ROOMID=a||"general";c.OPTIONS=b||{};c.list={};c.createServer();return c},{MSG_TYPE:{CHAT:1,NEW_MEMBER:2,RENAME:3,DEPARTURE:5,BROADCAST:6,PING:7,ACK:8,MEMBERS_REQ:9,MEMBERS_REP:10},_events:null,event:Peer.prototype.emit,on:Peer.prototype.on,off:Peer.prototype.off,emptyConnToClients:function(){if(this.connToClients)for(var a in this.connToClients)this.closeClientConnection(this.connToClients[a]);this.connToClients={}},handleConnToClient:function(a){var b=
this;this.connToClients[a].on("open",function(){b.broadcast({type:b.MSG_TYPE.NEW_MEMBER,peerid:a,peername:b.connToClients[a].peername});b.connToClients[a].on("error",b.event.bind(b,"error"))});this.connToClients[a].on("data",function(a){switch(a.type){case b.MSG_TYPE.CHAT:b.connToClients[a.peerid].peername=a.peername;b.broadcast({type:b.MSG_TYPE.BROADCAST,peerid:a.peerid,peername:a.peername,data:a.data});break;case b.MSG_TYPE.RENAME:b.connToClients[a.peerid].peername=a.peername,b.broadcast({type:b.MSG_TYPE.RENAME,
peerid:a.peerid,peername:a.peername});case b.MSG_TYPE.PING:b.connToClients[a.peerid]._lastPingTimestamp=(new Date).getTime();b.connToClients[a.peerid].send({type:b.MSG_TYPE.ACK,timestamp:(new Date).getTime()});break;case b.MSG_TYPE.MEMBERS_REQ:var c=[],d;for(d in b.connToClients)c.push({peerid:d,peername:b.connToClients[d].peername});b.connToClients[a.peerid].send({type:b.MSG_TYPE.MEMBERS_REP,members:c})}});this.broadcastDepartureOnClose(this.connToClients[a])},broadcastDepartureOnClose:function(a){var b=
this;a.on("close",function(){b.closeClientConnection(a)})},closeClientConnection:function(a){a.close();delete this.connToClients[a.peer];a._pingInterval&&clearInterval(a._pingInterval);this.broadcast({type:this.MSG_TYPE.DEPARTURE,peerid:a.peer,peername:a.peername})},broadcast:function(a){for(var b in this.connToClients)this.connToClients[b].send({type:a.type,peerid:a.peerid,peername:a.peername,data:a.data})},createServer:function(){var a=this;this._lastAckTimestamp=null;this.emptyConnToClients();
this.server=new Peer(this.ROOMID,this.OPTIONS);this.server.on("error",function(b){b.toString().match(/ID.*is taken/)&&a.createClient(a.server=null)});this.server.on("open",function(){a.createClient();a.server.on("connection",function(b){a.connToClients[b.peer]=b;a.handleConnToClient(b.peer)})})},createClient:function(){var a=this;this.client=new Peer(this.OPTIONS);this.client.on("error",this.event.bind(this,"error"));this.client.on("open",function(b){a.id=b;a.connToServer=a.client.connect(a.ROOMID);
a.connToServer.on("open",function(){a.OPTIONS.name&&a.connToServer.send({type:a.MSG_TYPE.RENAME,peerid:a.id,peername:a.OPTIONS.name});a.handleConnToServer();a.client.disconnect();a.refreshMembersInterval&&clearInterval(a.refreshMembersInterval);a.refreshMembers(a);a.refreshMembersInterval=setInterval(a.refreshMembers,3E4,a)})})},send:function(a){this.connToServer.send({type:this.MSG_TYPE.CHAT,peerid:this.client.id||this.client._lastServerId,peername:this.OPTIONS.name||this.id,data:a})},handleConnToServer:function(){var a=
this;this.connToServer.on("error",this.event.bind(this,"error"));this.connToServer.on("data",function(b){switch(b.type){case a.MSG_TYPE.NEW_MEMBER:var c=b.peername||b.peerid;a.list[b.peerid]=c;a.event("join",c);break;case a.MSG_TYPE.RENAME:c=b.peername||b.peerid;a.list[b.peerid]=c;break;case a.MSG_TYPE.BROADCAST:c=b.peername||b.peerid;a.list[b.peerid]=c;a.event("data",{id:b.peerid==a.id?"me":b.peerid,name:c,data:b.data});break;case a.MSG_TYPE.DEPARTURE:c=b.peername||b.peerid;delete a.list[b.peerid];
a.event("left",c);break;case a.MSG_TYPE.ACK:if(!a._lastAckTimestamp||a._lastAckTimestamp<b.timestamp)a._lastAckTimestamp=b.timestamp;break;case a.MSG_TYPE.MEMBERS_REP:a.list={};for(var e=0;e<b.members.length;e++){var d=b.members[e];c=d.peername||d.peerid;a.list[d.peerid]=c}}a.event("list",a.list)});this.connToServer.on("close",function(){a.createServer()})},refreshMembers:function(a){a.connToServer.send({type:a.MSG_TYPE.MEMBERS_REQ,peerid:a.client.id||a.client._lastServerId})}});